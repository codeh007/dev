{
  "name": "GoMTM Dev Environment",
  "image": "docker.io/gitgit188/gomtm:v0.8.1775",
  "privileged": true,
  "remoteUser": "code",

  "features": {
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      // Debian 12/Ubuntu 24.04 默认支持 Moby，保持注释即可
      // "moby": false, 
      "dockerDashComposeVersion": "v2"
    }
  },

  // ❌ 不要在这里挂载 /var/lib/docker。
  // 我们要使用容器内部的 /tmp (118GB)，而不是宿主机的卷。
  "mounts": [],

  "hostRequirements": {
    "cpus": 4
  },

  // 覆盖默认 CMD，确保容器不会退出
  "overrideCommand": true,
  "command": ["sleep", "infinity"],

  "customizations": {
    "vscode": {
      "settings": {
        "terminal.integrated.defaultProfile.linux": "bash"
      }
    }
  },

  // ✅ 核心魔法：使用一段 Shell 脚本作为 postStartCommand
  // 逻辑：
  // 1. 检查 Docker 是否已经使用了 /tmp/docker-root
  // 2. 如果没用，则执行"PID修复+配置修改+服务重启" (复刻了你验证成功的逻辑)
  // 3. 最后启动 gomtm
  "postStartCommand": "sudo bash -c 'if [[ $(docker info --format \"{{.DockerRootDir}}\") != \"/tmp/docker-root\" ]]; then echo \"Moving Docker to /tmp...\"; echo $(pidof dockerd) > /var/run/docker-ssd.pid; service docker stop; echo \"{\\\"data-root\\\": \\\"/tmp/docker-root\\\", \\\"storage-driver\\\": \\\"overlay2\\\"}\" > /etc/docker/daemon.json; mkdir -p /tmp/docker-root; service docker start; while ! docker info >/dev/null 2>&1; do sleep 1; done; fi' && sudo nohup gomtm entrypoint --mtgate-url=https://mtgateapi.yuepa8.com > /tmp/gomtm-start.log 2>&1 &",

  "postAttachCommand": "gomtm upgrade && gomtm install --dev"
}
